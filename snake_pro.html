<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Yƒ±lanlar Mƒ±ntƒ±kasƒ± V60 | SONSUZ.AY</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        body { background: #000; margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        canvas { display: block; background: radial-gradient(circle, #101010, #000); touch-action: none; }
        
        /* OYUN ARAY√úZ√ú */
        #arayuz { position: absolute; top: 20px; left: 20px; color: #00ff7f; z-index: 50; pointer-events: none; font-weight: bold; font-size: 24px; text-shadow: 2px 2px 4px #000; }
        #goldDisplay { margin-top: 5px; color: #FFD700; font-size: 20px; display: flex; align-items: center; gap: 5px; }
        #powerups { position: absolute; top: 85px; left: 20px; z-index: 50; display: flex; flex-direction: column; gap: 8px; }
        .pu-timer { color: #fff; font-size: 14px; font-weight: bold; background: rgba(0,0,0,0.7); padding: 5px 12px; border-radius: 10px; border-left: 5px solid #00ff7f; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        #leaderboard { position: absolute; top: 20px; right: 20px; width: 190px; background: rgba(0, 0, 0, 0.8); border: 1px solid #00ff7f; border-radius: 12px; padding: 12px; color: white; z-index: 50; font-size: 14px; pointer-events: none; }
        #rankList div { display: flex; justify-content: space-between; margin-bottom: 5px; }
        #joystickContainer { position: absolute; bottom: 60px; left: 60px; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; border: 2px solid #00ff7f; z-index: 60; }
        #joystickKnob { position: absolute; width: 45px; height: 45px; background: #00ff7f; border-radius: 50%; top: 32.5px; left: 32.5px; box-shadow: 0 0 20px #00ff7f; pointer-events: none; }
        .floating-text { position: absolute; color: #FFD700; font-weight: bold; font-size: 20px; pointer-events: none; animation: floatUp 1s ease-out forwards; text-shadow: 1px 1px 2px black; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* MEN√ú Sƒ∞STEMƒ∞ */
        #menuContainer { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.96); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; transition: 0.3s; }
        .logo-text { font-size: 32px; color: #00ff7f; letter-spacing: 3px; margin-bottom: 5px; text-shadow: 0 0 20px rgba(0,255,127,0.5); font-weight: 800; }
        .version-text { color: #888; font-size: 12px; margin-bottom: 20px; }
        .gold-badge { color: #FFD700; font-size: 20px; font-weight: bold; border: 2px solid #FFD700; padding: 8px 25px; border-radius: 20px; background: rgba(0,0,0,0.6); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        input { background: #111; border: 2px solid #00ff7f; color: white; padding: 12px; border-radius: 10px; margin-bottom: 20px; text-align: center; width: 220px; font-size: 18px; outline: none; }
        
        .category-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .cat-btn { width: 110px; height: 110px; background: #1a1a1a; border: 2px solid #444; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative; }
        .cat-btn:active { transform: scale(0.95); }
        .cat-btn span { font-size: 32px; margin-bottom: 10px; }
        .cat-btn div { font-size: 12px; font-weight: bold; color: #ccc; }
        .cat-btn.music-btn { border-color: #bb00ff; background: #1a001a; }
        
        #btnStart { background: #00ff7f; border: none; padding: 18px 80px; font-size: 24px; font-weight: bold; border-radius: 50px; cursor: pointer; color: #000; box-shadow: 0 0 30px rgba(0,255,127,0.6); transition: 0.2s; }
        #btnStart:active { transform: scale(0.95); }

        /* ALT MEN√úLER */
        .sub-menu { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #080808; z-index: 101; display: none; flex-direction: column; align-items: center; padding-top: 20px; }
        .sub-header { width: 90%; display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .back-btn { font-size: 28px; background: none; border: none; cursor: pointer; color: white; }
        .sub-title { font-size: 22px; font-weight: bold; color: #00ff7f; }
        
        .skin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 90%; max-height: 70vh; overflow-y: auto; padding-bottom: 50px; }
        .skin-card { background: #111; border-radius: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; cursor: pointer; border: 2px solid transparent; position: relative; }
        .skin-card.selected { border-color: #00ff7f; background: #1f2f25; }
        .skin-card.locked { opacity: 0.6; }
        
        .preview-circle { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); overflow: hidden; }
        .skin-name { font-size: 11px; color: #aaa; margin-bottom: 5px; text-align: center; }
        .skin-price { font-size: 12px; color: #FFD700; font-weight: bold; }
        .buy-btn-small { margin-top: 5px; background: #FFD700; border: none; border-radius: 5px; padding: 4px 10px; font-size: 11px; font-weight: bold; cursor: pointer; color: #000; }
        
        #currentPreview { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #00ff7f; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 0 30px rgba(0,255,127,0.3); overflow: hidden; }
        #musicBtn { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: transparent; border: 1px solid #555; color: #555; font-size: 12px; padding: 5px 10px; border-radius: 10px; cursor: pointer; z-index: 60; }
    </style>
</head>
<body>
    <div id="menuContainer">
        <div class="logo-text">SONSUZ.AY</div>
        <div class="version-text">V60 | MEGA KOLEKSƒ∞YON</div>
        <div id="currentPreview"></div>
        <div class="gold-badge">üí∞ <span id="menuGold">0</span></div>
        <input type="text" id="playerName" placeholder="Kaptan ƒ∞smi" maxlength="12">
        <div class="category-container">
            <div class="cat-btn" onclick="openSubMenu('colors')"><span>üé®</span><div>RENKLER</div></div>
            <div class="cat-btn" onclick="openSubMenu('costumes')"><span>üé≠</span><div>KOST√úMLER</div></div>
            <div class="cat-btn music-btn" onclick="openSubMenu('music')"><span>üéµ</span><div>MELODƒ∞LER</div></div>
        </div>
        <button id="btnStart" onclick="oyunuBaslat()">BA≈ûLAT</button>
    </div>

    <div id="subMenu" class="sub-menu">
        <div class="sub-header">
            <button class="back-btn" onclick="closeSubMenu()">‚¨ÖÔ∏è</button>
            <div class="sub-title" id="subMenuTitle">MAƒûAZA</div>
            <div class="gold-badge" style="font-size:16px; margin:0; padding: 5px 15px;">üí∞ <span id="subGold">0</span></div>
        </div>
        <div id="skinGrid" class="skin-grid"></div>
    </div>

    <button id="musicBtn" onclick="toggleMusic()">üéµ M√ºzik: A√áIK</button>
    <div id="arayuz">SKOR: <span id="skor">0</span><div id="goldDisplay">üí∞ <span id="gameGoldCount">0</span></div></div>
    <div id="powerups"></div>
    <div id="leaderboard"><h3>Lƒ∞DERLER</h3><div id="rankList"></div></div>
    <canvas id="game"></canvas>
    <div id="joystickContainer"><div id="joystickKnob"></div></div>

    <script>
        const SAVE_KEY = 'yilanData_V60';
        let userData = { gold: 0, unlockedSkins: [0], selectedSkin: 0, unlockedMusic: [0], selectedMusic: 0 };

        const ALL_MUSIC = [
            { id: 0, n: "Klasik Macera", price: 0, icon: "üéπ", speed: 1.2, notes: [261.63, 293.66, 329.63, 392.00, 440.00, 392.00, 329.63, 293.66] },
            { id: 1, n: "Sakin Piyano", price: 100, icon: "üßñ", speed: 2.0, notes: [196.00, 220.00, 246.94, 293.66, 246.94, 220.00] }, 
            { id: 2, n: "8-Bit Aksiyon", price: 250, icon: "üëæ", speed: 0.6, notes: [523.25, 392.00, 329.63, 493.88, 523.25, 659.25, 523.25] },
            { id: 3, n: "Gizemli Uzay", price: 500, icon: "üõ∏", speed: 1.8, notes: [130.81, 155.56, 196.00, 155.56, 233.08, 196.00] },
            { id: 4, n: "Karanlƒ±k Mod", price: 1000, icon: "üåë", speed: 1.5, notes: [110.00, 123.47, 130.81, 146.83, 110.00, 98.00] }
        ];

        // --- DEVASA Bƒ∞RLE≈ûTƒ∞Rƒ∞LMƒ∞≈û Lƒ∞STE ---
        const ALL_SKINS = [
            // --- RENKLER (ESKƒ∞ + YENƒ∞ + V58 + V59 HEPSƒ∞) ---
            { id: 0, cat: 'color', n: "G√∂kku≈üaƒüƒ±", price: 0, t: "rain", s: 6 },
            { id: 1, cat: 'color', n: "Kƒ±rmƒ±zƒ±-Mavi", price: 20, t: "stripe", c1: "#ff0033", c2: "#00bfff" },
            { id: 2, cat: 'color', n: "Neon Mor", price: 50, t: "stripe", c1: "#00ff7f", c2: "#bb00ff" },
            { id: 3, cat: 'color', n: "Siber Hƒ±z", price: 75, t: "stripe", c1: "#ff00ff", c2: "#00ffff" },
            { id: 4, cat: 'color', n: "Altƒ±n Siyah", price: 100, t: "stripe", c1: "#ffcc00", c2: "#111111" },
            { id: 5, cat: 'color', n: "≈ûeker", price: 120, t: "stripe", c1: "#ff69b4", c2: "#00bfff" },
            { id: 6, cat: 'color', n: "Neon Akƒ±≈üƒ±", price: 150, t: "flow", s: 8 }, 
            { id: 7, cat: 'color', n: "Zehir", price: 150, t: "grad", c1: "#4b0082", c2: "#00ff00" },   
            { id: 8, cat: 'color', n: "Buzul", price: 200, t: "grad", c1: "#e0ffff", c2: "#00ced1" },   
            { id: 9, cat: 'color', n: "≈ûeker √áubuƒüu", price: 250, t: "multiStripe", colors: ["#ff0000", "#ffffff", "#ff0000", "#ffffff"] },
            { id: 10, cat: 'color', n: "Arƒ±", price: 300, t: "stripe", c1: "#FFD700", c2: "#111111" },
            { id: 11, cat: 'color', n: "Volkan", price: 300, t: "grad", c1: "#8b0000", c2: "#ff4500" },
            { id: 12, cat: 'color', n: "Tropikal", price: 400, t: "multiStripe", colors: ["#00ff00", "#ffff00", "#00bfff"] },
            { id: 13, cat: 'color', n: "Gece", price: 400, t: "grad", c1: "#00008b", c2: "#00bfff" },
            { id: 14, cat: 'color', n: "Lav Akƒ±≈üƒ±", price: 500, t: "grad", c1: "#8b0000", c2: "#ff4500" },
            { id: 15, cat: 'color', n: "Zehirli Sarma≈üƒ±k", price: 750, t: "multiStripe", colors: ["#006400", "#00ff7f", "#adff2f"] },
            { id: 16, cat: 'color', n: "Gece Mavisi", price: 800, t: "grad", c1: "#00008b", c2: "#00bfff" },
            { id: 17, cat: 'color', n: "Altƒ±n Kaplama", price: 1000, t: "solid", c: "#FFD700" },
            { id: 18, cat: 'color', n: "Mat Siyah", price: 1200, t: "solid", c: "#222222" },
            { id: 19, cat: 'color', n: "Plazma", price: 1500, t: "flow", s: 15 },

            // --- KOST√úMLER (ESKƒ∞ + YENƒ∞ + EMOJƒ∞LER + HAYVANLAR) ---
            { id: 20, cat: 'costume', n: "Sade Neon", price: 200, t: "solid", c: "#00ff7f" },
            { id: 21, cat: 'costume', n: "Sade Mor", price: 250, t: "solid", c: "#bb00ff" },
            { id: 22, cat: 'costume', n: "≈ûeytan", price: 350, t: "emoji", icon: "üòà", c: "#800080" },
            { id: 23, cat: 'costume', n: "Korsan", price: 450, t: "emoji", icon: "‚ò†Ô∏è", c: "#333333" },
            { id: 24, cat: 'costume', n: "Havalƒ±", price: 550, t: "emoji", icon: "üòé", c: "#FFD700" },
            { id: 25, cat: 'costume', n: "Kovboy", price: 700, t: "emoji", icon: "ü§†", c: "#D2691E" },
            { id: 26, cat: 'costume', n: "Panda", price: 800, t: "emoji", icon: "üêº", c: "#ffffff" },
            { id: 27, cat: 'costume', n: "Uzaylƒ±", price: 900, t: "emoji", icon: "üëΩ", c: "#32CD32" },
            { id: 28, cat: 'costume', n: "Kurt", price: 900, t: "emoji", icon: "üê∫", c: "#708090" },
            { id: 29, cat: 'costume', n: "Robot", price: 1100, t: "emoji", icon: "ü§ñ", c: "#708090" },
            { id: 30, cat: 'costume', n: "ASLAN", price: 1200, t: "emoji", icon: "ü¶Å", c: "#FF8C00" },
            { id: 31, cat: 'costume', n: "Palya√ßo", price: 1300, t: "emoji", icon: "ü§°", c: "#FF4500" },
            { id: 32, cat: 'costume', n: "KAPLAN", price: 1500, t: "emoji", icon: "üêØ", c: "#FF4500" },
            { id: 33, cat: 'costume', n: "Etiketli", price: 1600, t: "accessory", subType: "tag", c: "#FF007F" },
            { id: 34, cat: 'costume', n: "Hayalet", price: 2000, t: "solid", c: "#ffffff", alpha: 0.4 },
            { id: 35, cat: 'costume', n: "Milyoner", price: 3000, t: "accessory", subType: "rich", c: "#006400" },
            { id: 36, cat: 'costume', n: "KRAL", price: 5000, t: "emoji", icon: "üëë", c: "#FF4500" }
        ];

        function loadData() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) { userData = JSON.parse(saved); }
            if(!userData.unlockedMusic) userData.unlockedMusic = [0];
            if(!userData.selectedMusic) userData.selectedMusic = 0;
            // Eski kayƒ±t varsa skinleri birle≈ütir
            if(!userData.unlockedSkins) userData.unlockedSkins = [0];
            updateMenuDisplay();
        }
        function saveData() { localStorage.setItem(SAVE_KEY, JSON.stringify(userData)); updateMenuDisplay(); }

        function updateMenuDisplay() {
            document.getElementById('menuGold').innerText = userData.gold;
            document.getElementById('subGold').innerText = userData.gold;
            renderPreview(userData.selectedSkin, document.getElementById('currentPreview'));
        }

        function openSubMenu(category) {
            document.getElementById('menuContainer').style.display = 'none';
            const subMenu = document.getElementById('subMenu'); subMenu.style.display = 'flex';
            const grid = document.getElementById('skinGrid'); grid.innerHTML = '';
            
            if (category === 'music') {
                document.getElementById('subMenuTitle').innerText = "M√úZƒ∞K MAƒûAZASI";
                ALL_MUSIC.forEach(music => createItemCard(music, 'music', grid));
            } else {
                document.getElementById('subMenuTitle').innerText = category === 'colors' ? "RENKLER" : "KOST√úMLER";
                const filteredSkins = ALL_SKINS.filter(s => (category === 'colors' && s.cat === 'color') || (category === 'costumes' && s.cat === 'costume'));
                filteredSkins.forEach(skin => createItemCard(skin, 'skin', grid));
            }
        }

        function createItemCard(item, type, container) {
            let isUnlocked, isSelected;
            if (type === 'music') {
                isUnlocked = userData.unlockedMusic.includes(item.id);
                isSelected = userData.selectedMusic === item.id;
            } else {
                isUnlocked = userData.unlockedSkins.includes(item.id);
                isSelected = userData.selectedSkin === item.id;
            }

            const card = document.createElement('div');
            card.className = `skin-card ${isSelected ? 'selected' : ''} ${!isUnlocked ? 'locked' : ''}`;
            
            card.onclick = () => {
                if (isUnlocked) {
                    if (type === 'music') userData.selectedMusic = item.id;
                    else userData.selectedSkin = item.id;
                    saveData(); 
                    container.innerHTML = ''; 
                    if(type==='music') ALL_MUSIC.forEach(m => createItemCard(m, 'music', container));
                    else openSubMenu(item.cat === 'color' ? 'colors' : 'costumes');
                } 
                else if (confirm(`${item.n} √ºr√ºn√ºn√º ${item.price} altƒ±na satƒ±n al?`)) {
                    if (userData.gold >= item.price) {
                        userData.gold -= item.price;
                        if (type === 'music') { userData.unlockedMusic.push(item.id); userData.selectedMusic = item.id; }
                        else { userData.unlockedSkins.push(item.id); userData.selectedSkin = item.id; }
                        saveData();
                        container.innerHTML = ''; 
                        if(type==='music') ALL_MUSIC.forEach(m => createItemCard(m, 'music', container));
                        else openSubMenu(item.cat === 'color' ? 'colors' : 'costumes');
                    } else { alert("Paran yetmiyor kaptan!"); }
                }
            };

            const circle = document.createElement('div'); circle.className = 'preview-circle';
            if (type === 'music') {
                circle.style.background = "#222"; circle.innerText = item.icon; circle.style.fontSize = "24px";
            } else { renderPreview(item.id, circle); }

            const name = document.createElement('div'); name.className = 'skin-name'; name.innerText = item.n;
            card.appendChild(circle); card.appendChild(name);

            if (!isUnlocked) {
                const price = document.createElement('div'); price.className = 'skin-price'; price.innerText = `${item.price} üí∞`;
                const btn = document.createElement('button'); btn.className = 'buy-btn-small'; btn.innerText = 'AL';
                card.appendChild(price); card.appendChild(btn);
            } else if (isSelected) {
                const selText = document.createElement('div'); selText.style.color = '#00ff7f'; selText.style.fontSize = '10px'; selText.innerText = 'SE√áƒ∞Lƒ∞';
                card.appendChild(selText);
            }
            container.appendChild(card);
        }

        function closeSubMenu() {
            document.getElementById('subMenu').style.display = 'none';
            document.getElementById('menuContainer').style.display = 'flex';
            updateMenuDisplay();
        }

        function renderPreview(skinId, element) {
            const s = ALL_SKINS.find(x => x.id === skinId) || ALL_SKINS[0];
            element.style.opacity = s.alpha || 1.0; 
            if(s.t === 'solid' || s.t === 'emoji' || s.t === 'accessory') element.style.background = s.c;
            else if(s.t === 'stripe') element.style.background = `repeating-linear-gradient(45deg, ${s.c1}, ${s.c1} 10px, ${s.c2} 10px, ${s.c2} 20px)`;
            else if(s.t === 'grad') element.style.background = `linear-gradient(45deg, ${s.c1}, ${s.c2})`;
            else if(s.t === 'rain' || s.t === 'flow') element.style.background = `linear-gradient(45deg, red, yellow, green, blue, purple)`;
            else if(s.t === 'multiStripe') {
                 let grad = s.colors.map((c, i) => `${c} ${i * (100/s.colors.length)}%`).join(', ');
                 element.style.background = `linear-gradient(45deg, ${grad})`;
            }
            element.innerText = '';
            if (s.t === 'emoji') element.innerText = s.icon;
            if (s.t === 'accessory' && s.subType === 'tag') element.innerText = "üè∑Ô∏è";
            if (s.t === 'accessory' && s.subType === 'rich') element.innerText = "üí≤";
        }

        // --- OYUN MOTORU ---
        const canvas = document.getElementById('game'), ctx = canvas.getContext('2d');
        const jContainer = document.getElementById('joystickContainer'), jKnob = document.getElementById('joystickKnob');
        const mapSize = 4620;

        let player = { id:'p', name:"Sen", originalName:"Sen", parts:[], angle:0, targetAngle:0, score:0, dead:false, stil:0, shield: 180, magnet:0, boost:0, double:0, radius: 11, growthPool: 0, isTitan: false };
        let bots = [], food = [], coins = [], bills = [], bags = [], activePowerups = [], active = false, hue = 0;
        let camera = { x: 0, y: 0, zoom: 1, targetZoom: 1 };
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let isMusicPlaying = true, nextNoteTime = 0, noteIndex = 0;
        
        function getActiveMelody() { const m = ALL_MUSIC.find(x => x.id === userData.selectedMusic); return m || ALL_MUSIC[0]; }
        function playTone(freq, time) {
            if(!isMusicPlaying || !active) return;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.frequency.value = freq; 
            const melody = getActiveMelody(); osc.type = melody.id === 2 ? 'square' : (melody.id === 3 ? 'triangle' : 'sine'); 
            osc.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0, time); gain.gain.linearRampToValueAtTime(0.04, time + 0.1); gain.gain.exponentialRampToValueAtTime(0.001, time + 2.5);
            osc.start(time); osc.stop(time + 2.5);
        }
        function scheduleMusic() {
            if(!isMusicPlaying || !active) return;
            const melody = getActiveMelody();
            while(nextNoteTime < audioCtx.currentTime + 0.1) {
                let note = melody.notes[noteIndex % melody.notes.length]; if(Math.random() < 0.2) note /= 2; 
                playTone(note, nextNoteTime); nextNoteTime += melody.speed; noteIndex++;
            }
            requestAnimationFrame(scheduleMusic);
        }
        function toggleMusic() {
            isMusicPlaying = !isMusicPlaying; document.getElementById('musicBtn').innerText = isMusicPlaying ? "üéµ M√ºzik: A√áIK" : "üéµ M√ºzik: KAPALI";
            if(isMusicPlaying && active) { if(audioCtx.state === 'suspended') audioCtx.resume(); nextNoteTime = audioCtx.currentTime; scheduleMusic(); }
        }

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();
        let isTouching=false, sx=0, sy=0;
        window.addEventListener("touchstart",e=>{ if(!active)return; isTouching=true; sx=e.touches[0].clientX; sy=e.touches[0].clientY; jContainer.style.display="block"; jContainer.style.left=(sx-55)+"px"; jContainer.style.top=(sy-55)+"px"; }, {passive: false});
        window.addEventListener("touchmove",e=>{ if(!isTouching)return; e.preventDefault(); let dx=e.touches[0].clientX-sx, dy=e.touches[0].clientY-sy; let d=Math.hypot(dx,dy); if(d>5){ let mx=(dx/d)*Math.min(d,35), my=(dy/d)*Math.min(d,35); jKnob.style.transform=`translate(${mx}px,${my}px)`; player.targetAngle=Math.atan2(dy,dx); } }, {passive: false});
        window.addEventListener("touchend",()=>{ isTouching=false; jContainer.style.display="none"; jKnob.style.transform="translate(0,0)"; });

        function spawnBot(customScore = null) {
            let bx=Math.random()*mapSize, by=Math.random()*mapSize; let p=[]; 
            let bSize; let startScore;
            if (customScore !== null) { startScore = customScore; bSize = Math.max(20, Math.floor(customScore / 10)); } 
            else {
                let rand = Math.random(); if (rand < 0.6) bSize = 28; else if (rand < 0.85) bSize = 80; else if (rand < 0.95) bSize = 150; else bSize = 300; 
                startScore = bSize * 10;
            }
            for(let i=0; i<bSize; i++) p.push({x:bx, y:by});
            // BOTLARA DEVASA Lƒ∞STEDEN RASTGELE SE√áƒ∞M
            let botStilId; do { botStilId = ALL_SKINS[Math.floor(Math.random()*ALL_SKINS.length)].id; } while (botStilId === player.stil);
            let botName = "Bot_"+Math.floor(Math.random()*999);
            bots.push({ id:Math.random(), name: botName, originalName: botName, parts:p, angle:Math.random()*6, targetAngle:Math.random()*6, score: startScore, stil:botStilId, dead:false, shield:180, radius:11, growthPool:0, magnet:0, boost:0, double:0, isTitan: false });
        }

        function spawnFood(x, y, isLoot = false) { if(!isLoot && food.length > 375) return; food.push({ x: x || Math.random() * mapSize, y: y || Math.random() * mapSize, h: Math.random() * 360, isLoot: isLoot, spawnTime: Date.now() }); }
        function spawnCoin() { if(coins.length < 60) coins.push({ x: Math.random()*mapSize, y: Math.random()*mapSize }); } 
        function spawnBill() { if(bills.length < 10) bills.push({ x: Math.random()*mapSize, y: Math.random()*mapSize }); }   
        function spawnBag() { if(bags.length < 6) bags.push({ x: Math.random()*mapSize, y: Math.random()*mapSize }); }      
        function spawnPowerup(){ const t=['magnet','boost','double'], i=['üß≤','‚ö°','‚ú®']; const idx=Math.floor(Math.random()*3); activePowerups.push({x:Math.random()*mapSize, y:Math.random()*mapSize, type:t[idx], icon:i[idx]}); }
        function handleDeath(s) { if(s.dead) return; s.dead = true; s.parts.forEach((p, idx) => { if(idx % 4 === 0) spawnFood(p.x, p.y, true); }); }
        function showFloatingText(text, x, y, color="#FFD700") {
            const el = document.createElement('div'); el.className = 'floating-text'; el.innerText = text;
            el.style.left = (canvas.width/2 + (x - camera.x)*camera.zoom) + 'px'; el.style.top = (canvas.height/2 + (y - camera.y)*camera.zoom) + 'px'; el.style.color = color;
            document.body.appendChild(el); setTimeout(() => el.remove(), 1000);
        }

        function oyunuBaslat(){
            if(audioCtx.state === 'suspended') audioCtx.resume();
            nextNoteTime = audioCtx.currentTime;
            
            let pNameInput = document.getElementById('playerName').value||"Sen";
            player.name = pNameInput; player.originalName = pNameInput; player.stil = userData.selectedSkin;
            
            document.getElementById('menuContainer').style.display='none';
            document.getElementById('arayuz').style.display='block';

            player.parts=[]; player.score=0; player.dead=false; player.radius=11; player.growthPool=0;
            player.magnet=0; player.boost=0; player.double=0; player.isTitan=false;
            camera.zoom=1; camera.targetZoom=1;
            document.getElementById('gameGoldCount').innerText = userData.gold; 

            for(let i=0;i<28;i++)player.parts.push({x:2000,y:2000});
            bots=[]; spawnBot(12000); spawnBot(9000); spawnBot(6000); for(let i=0;i<22;i++) spawnBot(null); 
            food=[]; for(let i=0;i<175;i++) spawnFood();
            activePowerups=[]; for(let i=0; i<12; i++) spawnPowerup();
            coins=[]; for(let i=0;i<60;i++) spawnCoin(); bills=[]; for(let i=0;i<10;i++) spawnBill(); bags=[]; for(let i=0;i<6;i++) spawnBag();
            active=true; scheduleMusic(); requestAnimationFrame(loop);
        }

        function botAI(b) {
            let head = b.parts[0]; let danger = false; let targetSet = false;
            if(head.x < 250 || head.x > mapSize-250 || head.y < 250 || head.y > mapSize-250) {
                let centerAngle = Math.atan2(mapSize/2 - head.y, mapSize/2 - head.x);
                let diff = centerAngle - b.angle; while(diff < -Math.PI) diff += Math.PI*2; while(diff > Math.PI) diff -= Math.PI*2;
                b.targetAngle += diff * 0.22; danger = true;
            } 
            if(!danger) {
                let scanDist = b.radius + 180; let nearestThreat = null; let minDist = 9999; const threats = [player, ...bots];
                for(let t of threats) {
                    if(t === b || t.dead) continue;
                    let d = Math.hypot(head.x - t.parts[0].x, head.y - t.parts[0].y);
                    if(d < scanDist && d < minDist) { minDist = d; nearestThreat = t; }
                }
                if(nearestThreat) { b.targetAngle = Math.atan2(head.y - nearestThreat.parts[0].y, head.x - nearestThreat.parts[0].x); danger = true; }
            }
            if(!danger) {
                let nearestPU = null; let minPUDist = 600; 
                activePowerups.forEach(pu => { let d = Math.hypot(head.x - pu.x, head.y - pu.y); if(d < minPUDist) { minPUDist = d; nearestPU = pu; } });
                if(nearestPU) {
                    let diff = Math.atan2(nearestPU.y - head.y, nearestPU.x - head.x) - b.angle;
                    while(diff < -Math.PI) diff += Math.PI*2; while(diff > Math.PI) diff -= Math.PI*2; b.targetAngle += diff * 0.15; targetSet = true;
                }
            }
            if(!danger && !targetSet) {
                let minFoodDist = 500; let bestFood = null;
                for(let k=0; k<20; k++) {
                    let rf = food[Math.floor(Math.random() * food.length)];
                    if(rf) {
                        let d = Math.hypot(head.x - rf.x, head.y - rf.y); let appeal = rf.isLoot ? d * 0.25 : d; 
                        if(appeal < minFoodDist) { minFoodDist = appeal; bestFood = rf; }
                    }
                }
                if(bestFood) {
                    let diff = Math.atan2(bestFood.y - head.y, bestFood.x - head.x) - b.angle;
                    while(diff < -Math.PI) diff += Math.PI*2; while(diff > Math.PI) diff -= Math.PI*2; b.targetAngle += diff * 0.10; targetSet = true;
                }
            }
            if(!danger && !targetSet) { if(Math.random() < 0.05) b.targetAngle += (Math.random()-0.5) * 2.0; }
        }

        function updateSnake(s, isP){
            if(s.dead)return;
            if(s.shield>0)s.shield--; if(s.magnet>0) s.magnet--; if(s.boost>0) s.boost--; if(s.double>0) s.double--;
            if(!isP) { botAI(s); }
            s.radius = Math.min(85, 11 + (s.score / 120)); 
            let maxTurnRate = 0.13; let diff = s.targetAngle - s.angle;
            while(diff < -Math.PI) diff += Math.PI*2; while(diff > Math.PI) diff -= Math.PI*2;
            if(diff > maxTurnRate) diff = maxTurnRate; if(diff < -maxTurnRate) diff = -maxTurnRate; s.angle += diff;
            let speed = (s.boost > 0) ? 6.8 : 3.8;
            let vx=Math.cos(s.angle), vy=Math.sin(s.angle); let len=Math.hypot(vx,vy)||1; vx/=len; vy/=len;
            s.parts[0].x += vx * speed; s.parts[0].y += vy * speed;
            if(s.parts[0].x<0||s.parts[0].x>mapSize||s.parts[0].y<0||s.parts[0].y>mapSize) { handleDeath(s); return; }
            const gap = s.radius * 0.45;
            for(let i=1; i<s.parts.length; i++){
                let dx=s.parts[i-1].x-s.parts[i].x, dy=s.parts[i-1].y-s.parts[i].y;
                let d=Math.hypot(dx,dy); if(d>gap){ let a=Math.atan2(dy,dx); s.parts[i].x=s.parts[i-1].x-Math.cos(a)*gap; s.parts[i].y=s.parts[i-1].y-Math.sin(a)*gap; }
            }
        }

        function checkTitan() {
            let livingSnakes = [player, ...bots].filter(s => !s.dead);
            if (livingSnakes.length === 0) return;
            let topSnake = livingSnakes.reduce((prev, current) => (prev.score > current.score) ? prev : current);
            livingSnakes.forEach(s => { s.isTitan = false; if (s.id !== 'p') s.name = s.originalName; });
            topSnake.isTitan = true; if (topSnake.id !== 'p') topSnake.name = "üíÄ Tƒ∞TAN üíÄ";
        }

        function loop(){
            if(!active)return;
            checkTitan(); updateSnake(player, true); bots.forEach(b=>updateSnake(b, false));
            const now = Date.now();
            for (let i = food.length - 1; i >= 0; i--) { if (food[i].isLoot && (now - food[i].spawnTime > 20000)) { food.splice(i, 1); } }

            const snakes=[player,...bots].filter(s=>!s.dead);
            snakes.forEach(s1=>{
                food.forEach((f,idx)=>{
                    let dist=Math.hypot(s1.parts[0].x-f.x, s1.parts[0].y-f.y);
                    if(s1.magnet>0 && dist<220){ f.x+=(s1.parts[0].x-f.x)*0.16; f.y+=(s1.parts[0].y-f.y)*0.16; }
                    if(dist < s1.radius + 12){
                        let m=(s1.double>0)?2:1; s1.score+=10*m; 
                        if(s1.id==='p') document.getElementById('skor').innerText=s1.score;
                        let baseGrowth = Math.max(0.1, 0.34 - (s1.score / 15000));
                        s1.growthPool += baseGrowth * m; while(s1.growthPool >= 1) { s1.parts.push({...s1.parts[s1.parts.length-1]}); s1.growthPool -= 1; }
                        food.splice(idx,1); setTimeout(() => spawnFood(), Math.random() * 2000 + 1000); 
                    }
                });
                if (s1.id === 'p') {
                    coins.forEach((c, idx) => { if (Math.hypot(s1.parts[0].x - c.x, s1.parts[0].y - c.y) < s1.radius + 25) { coins.splice(idx, 1); userData.gold += 1; saveData(); document.getElementById('gameGoldCount').innerText = userData.gold; showFloatingText("+1 ü™ô", c.x, c.y); setTimeout(spawnCoin, 5000); } });
                    bills.forEach((b, idx) => { if (Math.hypot(s1.parts[0].x - b.x, s1.parts[0].y - b.y) < s1.radius + 25) { bills.splice(idx, 1); userData.gold += 5; saveData(); document.getElementById('gameGoldCount').innerText = userData.gold; showFloatingText("+5 üíµ", b.x, b.y, "#85bb65"); setTimeout(spawnBill, 10000); } });
                    bags.forEach((b, idx) => { if (Math.hypot(s1.parts[0].x - b.x, s1.parts[0].y - b.y) < s1.radius + 30) { bags.splice(idx, 1); userData.gold += 10; saveData(); document.getElementById('gameGoldCount').innerText = userData.gold; showFloatingText("+10 üí∞", b.x, b.y, "#FFD700"); setTimeout(spawnBag, 20000); } });
                }
                activePowerups.forEach((pu, idx)=>{
                    let pickupRange = s1.radius + 40; if(Math.hypot(s1.parts[0].x-pu.x, s1.parts[0].y-pu.y) < pickupRange){ s1[pu.type] = (pu.type === 'double' ? 900 : 600); activePowerups.splice(idx,1); setTimeout(spawnPowerup, 8000); }
                });
                snakes.forEach(s2 => {
                   if(s1.id !== s2.id && s2.shield <= 0) {
                       for(let j=0; j<s2.parts.length; j+=4) { let hitDist = s1.radius + s2.radius * 0.6; if(Math.hypot(s1.parts[0].x - s2.parts[j].x, s1.parts[0].y - s2.parts[j].y) < hitDist) { handleDeath(s1); } }
                   }
                });
            });

            let leaders = snakes.sort((a,b)=>b.score-a.score).slice(0,6);
            document.getElementById('rankList').innerHTML = leaders.map((l,i)=>`<div><span>${i+1}. ${l.name}</span><span>${l.score}</span></div>`).join('');

            if(player.dead){ active=false; setTimeout(() => { document.getElementById('menuContainer').style.display='flex'; document.getElementById('arayuz').style.display='none'; updateMenuDisplay(); }, 500); return; }
            
            bots=bots.filter(b=>!b.dead); while(bots.length<25) spawnBot(null);
            while(activePowerups.length < 12) spawnPowerup();
            while(coins.length < 60) spawnCoin(); while(bills.length < 10) spawnBill(); while(bags.length < 6) spawnBag();

            camera.targetZoom=Math.max(.25, 1/(1+player.score/5000));
            camera.zoom+=(camera.targetZoom-camera.zoom)*.03;
            camera.x=player.parts[0].x-(canvas.width/2)/camera.zoom;
            camera.y=player.parts[0].y-(canvas.height/2)/camera.zoom;

            draw();
            requestAnimationFrame(loop);
        }

        function draw(){
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.save();
            ctx.scale(camera.zoom, camera.zoom); ctx.translate(-camera.x, -camera.y);
            ctx.strokeStyle='#00ff7f'; ctx.lineWidth=15; ctx.strokeRect(0,0,mapSize,mapSize);
            
            food.forEach(f=>{ ctx.beginPath(); ctx.arc(f.x,f.y, f.isLoot ? 8 : 6, 0, 7); if(f.isLoot) { let age = Date.now() - f.spawnTime; let opacity = Math.max(0.2, 1 - (age / 20000)); ctx.globalAlpha = opacity; ctx.fillStyle = "#fff"; ctx.shadowBlur = 15; ctx.shadowColor = "#FFD700"; } else { ctx.globalAlpha = 1.0; ctx.fillStyle = `hsl(${f.h},100%,50%)`; ctx.shadowBlur = 0; } ctx.fill(); ctx.shadowBlur = 0; ctx.globalAlpha = 1.0; });

            ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.shadowBlur = 10; ctx.shadowColor = "white"; 
            coins.forEach(c => { ctx.font = "24px Arial"; ctx.fillText("ü™ô", c.x, c.y); });
            bills.forEach(b => { ctx.font = "28px Arial"; ctx.fillText("üíµ", b.x, b.y); });
            bags.forEach(b => { ctx.font = "32px Arial"; ctx.fillText("üí∞", b.x, b.y); });
            ctx.shadowBlur = 0; 

            activePowerups.forEach(pu=>{ ctx.font = "34px Arial"; ctx.textAlign="center"; ctx.fillText(pu.icon, pu.x, pu.y+12); ctx.beginPath(); ctx.arc(pu.x, pu.y, 25, 0, 7); ctx.strokeStyle="#fff"; ctx.lineWidth=2; ctx.stroke(); });
            
            hue+=2;
            [...bots, player].forEach(s=>{
                if(s.dead)return;
                const st = ALL_SKINS.find(x => x.id === s.stil) || ALL_SKINS[0];
                ctx.globalAlpha = (s.shield > 0 ? 0.5 : 1.0) * (st.alpha || 1.0); 
                
                ctx.fillStyle="white"; ctx.font="bold 12px Arial"; ctx.textAlign="center";
                let displayName = s.name;
                if (s.id === 'p' && s.isTitan) displayName = "üíÄ " + s.originalName + " üíÄ";
                if(s.magnet > 0) displayName += " üß≤"; if(s.boost > 0) displayName += " ‚ö°"; if(s.double > 0) displayName += " ‚ú®";
                if(s.isTitan) { ctx.font="bold 22px Arial"; ctx.fillStyle = "#FFD700"; } else { ctx.font="bold 12px Arial"; ctx.fillStyle = "white"; }
                ctx.fillText(displayName, s.parts[0].x, s.parts[0].y-(s.radius+20)); 

                for(let i=s.parts.length-1; i>=0; i--){
                    let r=i===0?s.radius+3:Math.max(7, s.radius-(i*0.015));
                    ctx.beginPath(); ctx.arc(s.parts[i].x, s.parts[i].y, r, 0, 7);
                    
                    if(i===0){ 
                        ctx.fillStyle = st.t==='solid'||st.t==='emoji'||st.t==='accessory'?st.c: (st.t==='stripe'||st.t==='grad'?st.c1:`hsl(0,100%,50%)`); 
                    } else {
                        if(st.t==='solid'||st.t==='emoji'||st.t==='accessory') ctx.fillStyle=st.c;
                        else if(st.t==='stripe') ctx.fillStyle=i%2===0?st.c1:st.c2;
                        else if(st.t==='grad') ctx.fillStyle=i%2===0?st.c1:st.c2;
                        else if(st.t==='rain') ctx.fillStyle=`hsl(${(hue+i*st.s)%360},100%,50%)`;
                        else if(st.t==='flow') ctx.fillStyle=`hsl(${(i*st.s)%360},100%,50%)`; 
                        else if(st.t==='multiStripe') ctx.fillStyle = st.colors[i % st.colors.length]; 
                    }
                    ctx.fill();

                    if (i === 0) {
                        ctx.save(); ctx.translate(s.parts[0].x, s.parts[0].y); ctx.rotate(s.angle);
                        let fontSize = s.radius * 2; ctx.font = `${fontSize}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                        if (st.t === 'emoji') { ctx.fillText(st.icon, 0, 0); } 
                        else if (st.t === 'accessory') {
                            if (st.subType === 'tag') { ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(s.radius + 10, 10); ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.stroke(); ctx.font = `${fontSize * 0.8}px Arial`; ctx.fillText("üè∑Ô∏è", s.radius + 15, 15); } 
                            else if (st.subType === 'rich') { ctx.font = `${fontSize * 0.8}px Arial`; ctx.fillStyle = "#00FF00"; ctx.fillText("üí≤", 0, -5); ctx.shadowBlur = 10; ctx.shadowColor="green"; ctx.fillText("üí≤", 0, -5); ctx.shadowBlur = 0; }
                        }
                        ctx.restore();
                    }
                }
                ctx.globalAlpha=1.0;
            });
            ctx.restore();
        }

        loadData(); updateMenuDisplay();
    </script>
</body>
</html>
